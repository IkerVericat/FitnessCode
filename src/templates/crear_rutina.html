<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitnessCode</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rutines.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        html, body {
            height: 100%;
            background: #181818 !important;
        }
        body {
            color: #fff;
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="mobile-frame d-flex flex-column" style="position:relative; min-height:100vh;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark w-100">
            <div class="container-fluid justify-content-between">
                <!-- Esquerra: Cancel·lar -->
                <a class="nav-link text-white" href="{{ url_for('index') }}">
                    Cancel·lar
                </a>
                <!-- Centre: Títol -->
                <span class="navbar-brand mx-auto fw-light" style="font-size:1.2rem;">
                    Crear Rutina
                </span>
                <!-- Dreta: Guardar -->
                <button class="btn btn-warning btn-sm" type="submit" form="form_crear_rutina">
                    Guardar
                </button>
            </div>
        </nav>

        <form id="form_crear_rutina" method="POST">
            <input type="text" name="titol" id="titol" class="form-control bg-dark text-white fs-4 py-3"
                placeholder="Títol de la Rutina">

            <div class="agrega_un_exercici" id="agregaUnExercici">
                <div class="w-100 text-center mt-0 mb-0" id="missatgeInicial">
                    <h2 style="margin-bottom: 0.2rem;">
                        <img src="{{ url_for('static', filename='images/barbell.png') }}" alt="Mancuerna"
                            style="height:2.5rem; filter: brightness(0) invert(0.6) sepia(1) saturate(0) hue-rotate(180deg);">
                    </h2>
                    <h2 class="fw-light mb-1" style="letter-spacing:1px;">Comença agregant un exercici a la teva rutina</h2>
                </div>
                <div class="text-center mb-3">
                    <!-- Aquí apareixeran els exercicis seleccionats -->
                    <div id="exercicisSeleccionats" class="mt-3"></div>
                    <div class="text-center mb-3">
                        <button class="btn btn-lg" type="button" id="agregarExercici" data-bs-toggle="modal" data-bs-target="#modalExercicis">
                            <i class="bi bi-plus"></i> Agrega exercici
                        </button>
                    </div>
                </div>
                <!-- Aquí apareixeran els exercicis seleccionats -->
                <div id="exercicisSeleccionats" class="mt-3"></div>
            </div>
        </form>


        <!-- Navbar inferior fijado dentro del mobile-frame -->
        <nav class="navbar navbar-dark bg-dark navbar-expand navbar-bottom"
             style="position:absolute; bottom:0; left:0; width:100%; border-radius:0 0 24px 24px;">
            <div class="container-fluid d-flex justify-content-around">
                <a href="{{ url_for('veure_progressos') }}" class="text-light text-center flex-fill py-2 text-decoration-none">
                    <i class="bi bi-house-fill" style="font-size: 1.4em;"></i><br>Inici
                </a>
                <a href="{{ url_for('index') }}" class="text-light text-center flex-fill py-2 text-decoration-none">
                    <i class="fas fa-dumbbell" style="font-size: 1.3em;"></i><br>Entrenament
                </a>
            </div>
        </nav>
    </div>

    <!-- Modal Bootstrap per mostrar exercicis -->
    <div class="modal fade" id="modalExercicis" tabindex="-1" aria-labelledby="modalExercicisLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tancar</button>
            <h5 class="modal-title w-100 text-center" id="modalExercicisLabel">Afegir Exercici</h5>
            <button type="button" class="btn btn-sm btn-warning py-2 px-3" id="afegirSeleccionats" style="height: 38px;">Afegir seleccionats</button>
          </div>
          <div class="modal-body">
            <div class="row">
              {% for exercici in exercicis %}
                <div class="col-12 col-md-6 mb-3">
                  <div class="card bg-secondary text-white h-100 flex-row align-items-center p-2 exercici-item"
                       data-nom="{{ exercici['nom'] }}">
                    <img src="{{ url_for('static', filename='images/' ~ exercici['imatge']) }}"
                         alt="{{ exercici['nom'] }}"
                         style="width:60px; height:60px; object-fit:contain; background:#222; border-radius:8px; margin-right:16px;">
                    <div>
                      <div class="fw-bold">{{ exercici['nom'] }}</div>
                      <div class="small text-warning">{{ exercici['muscul'] }}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let seleccionats = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Selecció visual d'exercicis
        document.querySelectorAll('.exercici-item').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
                const nom = this.getAttribute('data-nom');
                if (this.classList.contains('active')) {
                    seleccionats.push(nom);
                } else {
                    seleccionats = seleccionats.filter(e => e !== nom);
                }
            });
        });

        // Afegir seleccionats a la rutina
        document.getElementById('afegirSeleccionats').addEventListener('click', function() {
            const zona = document.getElementById('exercicisSeleccionats');
            zona.innerHTML = '';
            seleccionats.forEach(nom => {
                // Busca la targeta original per obtenir la imatge i múscul
                const card = document.querySelector(`.exercici-item[data-nom="${nom}"]`);
                const imgSrc = card.querySelector('img').src;
                zona.innerHTML += `
                <div class="card bg-dark text-white mb-3">
                    <div class="card-body d-flex align-items-center">
                        <img src="${imgSrc}" alt="${nom}" style="width:60px; height:60px; object-fit:contain; background:#222; border-radius:8px; margin-right:16px;">
                        <div>
                            <div class="fw-bold">${nom}</div>
                            <div class="series-container">
                                <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">Sèrie</span>
                                    <input type="number" class="form-control" placeholder="Kg">
                                    <input type="number" class="form-control" placeholder="Reps">
                                </div>
                            </div>
                            <button class="btn btn-outline-warning btn-sm add-serie">Afegir sèrie</button>
                        </div>
                    </div>
                </div>
                `;
            });
            document.getElementById('missatgeInicial').style.display = 'none';
            var modal = bootstrap.Modal.getInstance(document.getElementById('modalExercicis'));
            modal.hide();

            // Afegir funcionalitat per afegir més sèries
            document.querySelectorAll('.add-serie').forEach(btn => {
                btn.addEventListener('click', function() {
                    const container = this.parentElement.querySelector('.series-container');
                    container.innerHTML += `
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text">Sèrie</span>
                            <input type="number" class="form-control" placeholder="Kg">
                            <input type="number" class="form-control" placeholder="Reps">
                        </div>
                    `;
                });
            });
        });

        document.getElementById('form_crear_rutina').addEventListener('submit', function(e) {
            // Recull totes les dades dels exercicis i sèries
            const exercicis = [];
            document.querySelectorAll('#exercicisSeleccionats .card').forEach(card => {
                const nom = card.querySelector('.fw-bold').innerText;
                const series = [];
                card.querySelectorAll('.series-container .input-group').forEach(grup => {
                    const kg = grup.querySelector('input[placeholder="Kg"]').value;
                    const reps = grup.querySelector('input[placeholder="Reps"]').value;
                    series.push({kg, reps});
                });
                exercicis.push({nom, series});
            });

            // Crea un input ocult amb les dades serialitzades
            let input = document.getElementById('exercicis_hidden');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'exercicis';
                input.id = 'exercicis_hidden';
                this.appendChild(input);
            }
            input.value = JSON.stringify(exercicis);
        });
    });
    </script>
</body>
</html>
